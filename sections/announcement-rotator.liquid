<section
  id="announcement-rotator-{{ section.id }}"
  class="announcement-rotator shopify-section--announcement-rotator {% if section.settings.full_width %}announcement-rotator--full{% endif %}"
  data-section-id="{{ section.id }}"
  data-rotation-speed="{{ section.settings.rotation_speed | default: 4000 }}"
>
  <div class="announcement-rotator__inner">
    {% if section.blocks.size > 0 %}
      {% for block in section.blocks %}
        <div
          class="announcement-rotator__item{% if forloop.first %} is-active{% endif %}"
          data-index="{{ forloop.index0 }}"
          {{ block.shopify_attributes }}
        >
          {% if block.settings.link != blank %}
            <a href="{{ block.settings.link }}" class="announcement-rotator__link">
              {{ block.settings.text | escape }}
            </a>
          {% else %}
            {{ block.settings.text | escape }}
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="announcement-rotator__item is-active">
        Add announcements in the section settings.
      </div>
    {% endif %}
  </div>

  {% if section.settings.show_close %}
    <button class="announcement-rotator__close" type="button" aria-label="Close">
      &times;
    </button>
  {% endif %}
</section>

<style>
  /* 1) Bar lives above everything and sticks to top */
  .shopify-section--announcement-rotator{
    position: sticky;
    top: 0;
    z-index: 3000; /* above header */
    margin: 0 !important;
    width: 100%;
  }

  /* keep your existing visual styles */
  #announcement-rotator-{{ section.id }}{
    background: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    font-size: 0.875rem;
    line-height: 1.4;
    position: relative;
    border-bottom: 1px solid rgba(0,0,0,.05);
  }

  /* give the inner a consistent height so we can offset the header */
  :root{ --announce-h: 40px; } /* default; script below will auto-measure */
  #announcement-rotator-{{ section.id }} .announcement-rotator__inner{
    min-height: var(--announce-h);
    display: flex;
    align-items: center;
    overflow: hidden;
    {% unless section.settings.full_width %}
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    {% else %}
      padding: 0 1rem;
    {% endunless %}
  }
</style>

<script>
  /* 2) Auto-measure bar height so wrapping text still works */
  (function(){
    var root = document.documentElement;
    var section = document.getElementById('announcement-rotator-{{ section.id }}');
    if(!section) return;

    function setH(){
      var h = section.offsetHeight || 40;
      root.style.setProperty('--announce-h', h + 'px');
    }
    setH();
    window.addEventListener('resize', setH);
  })();
</script>





<script>
  document.addEventListener('DOMContentLoaded', function () {
    var bar = document.querySelector('.shopify-section--announcement-rotator');
    if (!bar) return;
    var h = bar.offsetHeight;
    document.documentElement.style.setProperty('--announcement-h', h + 'px');
  });
</script>


<script>
  (function() {
    var sectionEl = document.getElementById('announcement-rotator-{{ section.id }}');
    if (!sectionEl) return;

    var items = sectionEl.querySelectorAll('.announcement-rotator__item');
    if (!items.length) return;

    var speed = parseInt(sectionEl.getAttribute('data-rotation-speed'), 10) || 4000;
    var current = 0;
    var timer;

    function show(index) {
      items.forEach(function(item, i) {
        item.classList.toggle('is-active', i === index);
      });
      current = index;
    }

    function startRotation() {
      if (items.length <= 1) return;
      timer = setInterval(function() {
        var next = current + 1;
        if (next >= items.length) next = 0;
        show(next);
      }, speed);
    }

    startRotation();

    var closeBtn = sectionEl.querySelector('.announcement-rotator__close');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        sectionEl.style.display = 'none';
        if (timer) clearInterval(timer);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Announcement rotator",
  "tag": "section",
  "class": "section-announcement-rotator",
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "range",
      "id": "rotation_speed",
      "label": "Rotation speed (ms)",
      "min": 2000,
      "max": 5000,
      "step": 500,
      "default": 4000
    },
    {
      "type": "checkbox",
      "id": "show_close",
      "label": "Show close button",
      "default": true
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "message",
      "name": "Message",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Free shipping on orders over $50"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (optional)"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Announcement rotator",
      "blocks": [
        {
          "type": "message",
          "settings": {
            "text": "New arrivals just dropped!"
          }
        },
        {
          "type": "message",
          "settings": {
            "text": "10% off with code TASHOLA10"
          }
        }
      ]
    }
  ]
}
{% endschema %}
