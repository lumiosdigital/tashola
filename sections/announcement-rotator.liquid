{% comment %}
  Announcement Rotator Section
  - Add multiple "message" blocks
  - Rotates through them with JS
  - Can be set to full-width or contained
{% endcomment %}

<section
  id="announcement-rotator-{{ section.id }}"
  class="announcement-rotator {% if section.settings.full_width %}announcement-rotator--full{% endif %}"
  data-section-id="{{ section.id }}"
  data-rotation-speed="{{ section.settings.rotation_speed | default: 4000 }}"
>
  <div class="announcement-rotator__inner">
    {% if section.blocks.size > 0 %}
      {% for block in section.blocks %}
        <div
          class="announcement-rotator__item{% if forloop.first %} is-active{% endif %}"
          data-index="{{ forloop.index0 }}"
          {{ block.shopify_attributes }}
        >
          {% if block.settings.link != blank %}
            <a href="{{ block.settings.link }}" class="announcement-rotator__link">
              {{ block.settings.text | escape }}
            </a>
          {% else %}
            {{ block.settings.text | escape }}
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="announcement-rotator__item is-active">
        Add announcements in the section settings.
      </div>
    {% endif %}
  </div>

  {% if section.settings.show_close %}
    <button class="announcement-rotator__close" type="button" aria-label="Close">
      &times;
    </button>
  {% endif %}
</section>

<style>
  #announcement-rotator-{{ section.id }} {
    background: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    font-size: 0.875rem;
    line-height: 1.4;
    position: relative;
  }
  #announcement-rotator-{{ section.id }} .announcement-rotator__inner {
    display: flex;
    align-items: center;
    min-height: 40px;
    overflow: hidden;
    {% unless section.settings.full_width %}
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    {% else %}
      padding: 0 1rem;
    {% endunless %}
  }
  #announcement-rotator-{{ section.id }} .announcement-rotator__item {
    display: none;
    white-space: nowrap;
  }
  #announcement-rotator-{{ section.id }} .announcement-rotator__item.is-active {
    display: block;
    animation: fadeInAnnouncement 0.35s ease;
  }
  #announcement-rotator-{{ section.id }} .announcement-rotator__link {
    color: inherit;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  #announcement-rotator-{{ section.id }} .announcement-rotator__close {
    background: none;
    border: 0;
    color: inherit;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
  }

  @keyframes fadeInAnnouncement {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 749px) {
    #announcement-rotator-{{ section.id }} .announcement-rotator__inner {
      justify-content: center;
    }
    #announcement-rotator-{{ section.id }} .announcement-rotator__item {
      white-space: normal;
      text-align: center;
    }
  }
</style>

<script>
  (function() {
    var sectionEl = document.getElementById('announcement-rotator-{{ section.id }}');
    if (!sectionEl) return;

    var items = sectionEl.querySelectorAll('.announcement-rotator__item');
    if (!items.length) return;

    var speed = parseInt(sectionEl.getAttribute('data-rotation-speed'), 10) || 4000;
    var current = 0;
    var timer;

    function show(index) {
      items.forEach(function(item, i) {
        item.classList.toggle('is-active', i === index);
      });
      current = index;
    }

    function startRotation() {
      if (items.length <= 1) return;
      timer = setInterval(function() {
        var next = current + 1;
        if (next >= items.length) next = 0;
        show(next);
      }, speed);
    }

    startRotation();

    // Close button
    var closeBtn = sectionEl.querySelector('.announcement-rotator__close');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        sectionEl.style.display = 'none';
        if (timer) clearInterval(timer);
      });
    }
  })();
</script>

{% schema %}
{
  "name": "Announcement rotator",
  "tag": "section",
  "class": "section-announcement-rotator",
  "settings": [
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "range",
      "id": "rotation_speed",
      "label": "Rotation speed (ms)",
      "min": 2000,
      "max": 5000,
      "step": 500,
      "default": 4000
    },
    {
      "type": "checkbox",
      "id": "show_close",
      "label": "Show close button",
      "default": true
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "message",
      "name": "Message",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Free shipping on orders over $50"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (optional)"
        }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Announcement rotator",
      "blocks": [
        {
          "type": "message",
          "settings": {
            "text": "New arrivals just dropped!"
          }
        },
        {
          "type": "message",
          "settings": {
            "text": "10% off with code TASHOLA10"
          }
        }
      ]
    }
  ]
}
{% endschema %}
